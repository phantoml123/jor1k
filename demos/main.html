<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>jor1k</title>
    <link rel="stylesheet" href="css/default.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: sans-serif;
        }
        #viewer, #terminal {
            width: 100vw;
            height: 100vh;
            display: none;
        }
        #viewer canvas, #terminal table {
            width: 100%;
            height: 100%;
        }
        #toggleBtn {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 999;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>
<body onload="Start()">

    <button id="toggleBtn" onclick="toggleView()">Switch to Viewer</button>

    <div id="terminal">
        <table id="tty" class="terminal" cellpadding="0" cellspacing="0" style="width:100%;height:100%;"></table>
    </div>

    <div id="viewer">
        <canvas id="fb" class="screen" width="640" height="400"></canvas>
    </div>

    <canvas id="fbfullscreen" width="640" height="400" style="display:none;"></canvas>

    <script src="jor1k-master-min.js"></script> 
    <script>
        var Jor1k = require("Jor1k");
        var LinuxTerm = require("LinuxTerm");

        var showingTerminal = true;

        function toggleView() {
            showingTerminal = !showingTerminal;
            document.getElementById("terminal").style.display = showingTerminal ? "block" : "none";
            document.getElementById("viewer").style.display = showingTerminal ? "none" : "block";
            document.getElementById("toggleBtn").innerText = showingTerminal ? "Switch to Viewer" : "Switch to Terminal";
        }

        function Fullscreen() {
            document.body.style.margin = '0px';
            window.onresize = function(event) {
                var w = window.innerWidth;
                var y = window.innerHeight;
                var d = w / y;
                if (d > 1.6) w = y * 1.6; else y = w / 1.6;
                var fb = document.getElementById("fbfullscreen");
                fb.style.width = w + "px";
                fb.style.height = y + "px";
            };
            window.onresize();
            jor1k.framebuffer.Init("fbfullscreen");
        }

        function OnUploadFiles(files) {
            var path = document.getElementById("loadPath").value;
            for (var i = 0, f; f = files[i]; i++) {
                jor1k.fs.UploadExternalFile(path, f);
            }
        }

        function RandomString(length) {
            var chars = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
            var result = '';
            for (var i = length; i > 0; --i) result += chars[Math.floor(Math.random() * chars.length)];
            return result;
        }

        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) return decodeURIComponent(pair[1]);
            }
            return false;
        }

        function Start() {
            var pushState = false, loadUserData = false;
            var userid = getQueryVariable("user") || (RandomString(10), pushState = true, RandomString(10));
            var relayURL = getQueryVariable("relayURL") || (pushState = true, "wss://relay.widgetry.org/");

            var jor1kparameters = {
                path: "../openrisc-sys/",
                system: {
                    kernelURL: "kernel/vmlinux.bin.bz2",
                    memorysize: 32,
                    cpu: "asm",
                    ncores: 1,
                },
                fs: {
                    basefsURL: "basefs.json",
                    extendedfsURL: "fs.json",
                    earlyload: [],
                    lazyloadimages: []
                },
                term: new LinuxTerm("tty"),
                fbid: "fb",
                clipboardid: "clipboard",
                statsid: "stats",
                fps: 10,
                relayURL: relayURL,
                userid: userid,
                syncURL: "//jor1k.com/sync/upload.php"
            };

            if (loadUserData) jor1kparameters.fs.lazyloadimages.push("sync/tarballs/" + userid + ".tar.bz2");

            var nCores = getQueryVariable("n");
            if (nCores !== false) jor1kparameters.system.ncores = nCores;

            var cpu = getQueryVariable("cpu");
            if (cpu !== false) {
                jor1kparameters.system.cpu = cpu;
                if (cpu == "smp") {
                    jor1kparameters.system.kernelURL = "kernel/vmlinuxsmp.bin.bz2";
                }
            }

            if (pushState) {
                window.history.pushState([], "", "?user=" + encodeURIComponent(userid) + "&cpu=" + encodeURIComponent(jor1kparameters.system.cpu) + "&n=" + encodeURIComponent(jor1kparameters.system.ncores) + "&relayURL=" + encodeURIComponent(relayURL));
            }

            jor1k = new Jor1k(jor1kparameters);

            // Show terminal by default
            document.getElementById("terminal").style.display = "block";
        }
    </script>
</body>
</html>
